// Copyright 2019 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package cliquepocr

import (
	"math/big"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/rawdb"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/core/vm"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/params"
)

// Clique proof-of-authority protocol constants.
var (
	extraSeal = crypto.SignatureLength // Fixed number of extra-data suffix bytes reserved for signer seal

	nonceAuthVote = hexutil.MustDecode("0xffffffffffffffff") // Magic nonce number to vote on adding a new signer
	nonceDropVote = hexutil.MustDecode("0x0000000000000000") // Magic nonce number to vote on removing a signer.

	uncleHash = types.CalcUncleHash(nil) // Always Keccak256(RLP([])) as uncles are meaningless outside of PoW.

	diffInTurn = big.NewInt(2) // Block difficulty for in-turn signatures
	diffNoTurn = big.NewInt(1) // Block difficulty for out-of-turn signatures
)

func TestReimportMirroredState(t *testing.T) {
	// This test case is a repro of an annoying bug that took us forever to catch.
	// In Clique PoA networks (Rinkeby, GÃ¶rli, etc), consecutive blocks might have
	// the same state root (no block subsidy, empty block). If a node crashes, the
	// chain ends up losing the recent state and needs to regenerate it from blocks
	// already in the database. The bug was that processing the block *prior* to an
	// empty one **also completes** the empty one, ending up in a known-block error.
	var (
		db        = rawdb.NewMemoryDatabase()
		key, _    = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		addr      = crypto.PubkeyToAddress(key.PublicKey)
		pocrAddr  = common.HexToAddress("0x0000000000000000000000000000000000000100")
		pocr2Addr = common.HexToAddress("0x0000000000000000000000000000000000000101")
		engine    = New(params.AllCliqueProtocolChanges.Clique, db)
		signer    = new(types.HomesteadSigner)
	)
	genspec := &core.Genesis{
		ExtraData: make([]byte, extraVanity+common.AddressLength+extraSeal),
		Alloc: map[common.Address]core.GenesisAccount{
			addr: {Balance: big.NewInt(10000000000000000)},
			pocrAddr: {
				Balance: big.NewInt(0),
				Code:    common.Hex2Bytes("0x6080604052600436106102555760003560e01c806379f8581611610139578063bda0b637116100b6578063db923e0b1161007a578063db923e0b1461081d578063de5e21c91461083d578063e317e5f01461087a578063e432d70c14610890578063e6bd69fe146108a5578063f05d5752146108db57600080fd5b8063bda0b6371461073b578063c16fe90714610750578063cacca4a0146107a8578063cc33b815146107c8578063da05ee98146107fd57600080fd5b80639f909f74116100fd5780639f909f74146106a6578063a3fc43ec146106c6578063b6c3dcf8146106e6578063badc2065146106fb578063bbadf64c1461071b57600080fd5b806379f85816146105ea5780637bbcf8d71461061757806388ffe8671461062c5780638d22ea2a1461063457806396a0de321461066d57600080fd5b80633c2f4a97116101d257806359caecb51161019657806359caecb51461050a57806360ef84a11461052a57806364b1c67e1461058057806367e7646f146105a057806368744564146105c057806374eb85f8146105d557600080fd5b80633c2f4a971461042e57806346c556cc1461046457806347962f8a1461048457806349145975146104ba57806353c239f4146104da57600080fd5b806312effc321161021957806312effc321461034457806319093299146103645780632863fad9146103a057806328a15c37146103c05780633ac172dd1461040e57600080fd5b806301d541ec1461026457806303b2ec98146102b2578063040e55f5146102d6578063045c6ce0146102eb57806309dcde7e1461030d57600080fd5b3661025f57600080fd5b600080fd5b34801561027057600080fd5b5061029d61027f366004612d40565b6001600160a01b031660009081526004602052604090205460ff1690565b60405190151581526020015b60405180910390f35b3480156102be57600080fd5b506102c860005481565b6040519081526020016102a9565b3480156102e257600080fd5b50600b546102c8565b3480156102f757600080fd5b5061030b610306366004612d64565b6108fb565b005b34801561031957600080fd5b5061032d610328366004612d7d565b610c4b565b6040805192151583526020830191909152016102a9565b34801561035057600080fd5b5061030b61035f366004612d64565b610d22565b34801561037057600080fd5b5061029d61037f366004612d40565b6001600160a01b031660009081526004602052604090206002015460ff1690565b3480156103ac57600080fd5b5061029d6103bb366004612da9565b610e67565b3480156103cc57600080fd5b506103f66103db366004612d64565b6000908152600560205260409020546001600160a01b031690565b6040516001600160a01b0390911681526020016102a9565b34801561041a57600080fd5b5061030b610429366004612d7d565b610ef7565b34801561043a57600080fd5b506102c8610449366004612d40565b6001600160a01b03166000908152600a602052604090205490565b34801561047057600080fd5b5061030b61047f366004612d7d565b61103c565b34801561049057600080fd5b506103f661049f366004612d64565b6001602052600090815260409020546001600160a01b031681565b3480156104c657600080fd5b5061030b6104d5366004612d40565b611269565b3480156104e657600080fd5b5061029d6104f5366004612d40565b60026020526000908152604090205460ff1681565b34801561051657600080fd5b5061030b610525366004612d64565b6113a7565b34801561053657600080fd5b5061056b610545366004612d40565b6001600160a01b0316600090815260046020526040902060078101546006909101549091565b604080519283526020830191909152016102a9565b34801561058c57600080fd5b5061029d61059b366004612d7d565b6114f6565b3480156105ac57600080fd5b5061030b6105bb366004612d40565b611723565b3480156105cc57600080fd5b5061030b611855565b3480156105e157600080fd5b50600e546102c8565b3480156105f657600080fd5b506102c8610605366004612d40565b60036020526000908152604090205481565b34801561062357600080fd5b506009546102c8565b61030b61191d565b34801561064057600080fd5b506103f661064f366004612d40565b6001600160a01b039081166000908152600f60205260409020541690565b34801561067957600080fd5b506102c8610688366004612d40565b6001600160a01b031660009081526004602052604090206001015490565b3480156106b257600080fd5b5061029d6106c1366004612d40565b61199a565b3480156106d257600080fd5b506102c86106e1366004612d40565b6119db565b3480156106f257600080fd5b506102c8611aaf565b34801561070757600080fd5b5061029d610716366004612d40565b611b07565b34801561072757600080fd5b5061030b610736366004612d64565b611bda565b34801561074757600080fd5b5061030b611f0c565b34801561075c57600080fd5b5061077061076b366004612d64565b611fc4565b6040805195865260208601949094526001600160a01b039092169284019290925260608301919091521515608082015260a0016102a9565b3480156107b457600080fd5b5061030b6107c3366004612d64565b612031565b3480156107d457600080fd5b506107e86107e3366004612d64565b612152565b6040516102a999989796959493929190612df8565b34801561080957600080fd5b5061029d610818366004612d40565b612266565b34801561082957600080fd5b5061030b610838366004612e5c565b6122b5565b34801561084957600080fd5b5061029d610858366004612da9565b6001600160a01b039081166000908152600f6020526040902054811691161490565b34801561088657600080fd5b506102c860065481565b34801561089c57600080fd5b5061030b612571565b3480156108b157600080fd5b506103f66108c0366004612d64565b6005602052600090815260409020546001600160a01b031681565b3480156108e757600080fd5b5061030b6108f6366004612d64565b61258c565b600e5481106109255760405162461bcd60e51b815260040161091c90612e8a565b60405180910390fd5b6000818152600d6020526040902061093c816127ae565b6109795760405162461bcd60e51b815260206004820152600e60248201526d1d9bdd19481a5cc818db1bdcd95960921b604482015260640161091c565b600080610984612809565b9092509050600082600281111561099d5761099d612de2565b036109e05760405162461bcd60e51b81526020600482015260136024820152726e6f7420616c6c6f77656420746f20766f746560681b604482015260640161091c565b8260080154600003610a2057436008840155600283546040517f8b4f54c8f369dfa88cad572b520d502c98a5b5fba0da475fff124aa383f883b790600090a35b6001826002811115610a3457610a34612de2565b03610b10576001600160a01b0381166000908152600784016020526040812054900b6001819003610a66575050505050565b8060000b60001903610ac657600584018054906000610a8483612ec7565b9091555050600484018054906000610a9b83612ede565b90915550506001600160a01b03821660009081526007850160205260409020805460ff191660011790555b8060000b600003610b0e57600484018054906000610ae383612ede565b90915550506001600160a01b03821660009081526007850160205260409020805460ff191660011790555b505b6002826002811115610b2457610b24612de2565b03610c00576001600160a01b0381166000908152600684016020526040812054900b6001819003610b56575050505050565b8060000b60001903610bb657600384018054906000610b7483612ec7565b9091555050600284018054906000610b8b83612ede565b90915550506001600160a01b03821660009081526006850160205260409020805460ff191660011790555b8060000b600003610bfe57600284018054906000610bd383612ede565b90915550506001600160a01b03821660009081526006850160205260409020805460ff191660011790555b505b806001600160a01b0316847f62b7bd68cddcb1b426af8b4081bdc15715aea8fdd2b2d2d089eed9fd7949f4fb846001604051610c3d929190612f0b565b60405180910390a350505050565b6001600160a01b038216600090815260046020526040812060020154819060ff16610c7b57506000905080610d1b565b6000610ca67f2245a186a3377a3ebaff278b0642aeae1bfb62eb3f0c54958a9873924182c1b0612871565b90506000610cd4866001600160a01b0316600090815260046020526040902060078101546006909101549091565b5090506000819003610cef5760016000935093505050610d1b565b6000610cfb8383612f26565b43101590506000610d0c8484612f26565b919550909350610d1b92505050565b9250929050565b610d2a612946565b610d955760405162461bcd60e51b815260206004820152603660248201527f6e6f7420616c6c6f77656420746f2072656a6563742061207472616e73666572604482015275206f6620636f6e666973636174656420706c6564676560501b606482015260840161091c565b600b548110610db65760405162461bcd60e51b815260040161091c90612e8a565b6000818152600c60205260409020600581015460ff1615610de95760405162461bcd60e51b815260040161091c90612f3e565b33600090815260048201602052604090205460ff1615610e6357600381018054906000610e1583612ec7565b90915550503360009081526004820160205260409020805460ff1916905560025b8154600383015460405190815260008051602061300e833981519152906020015b60405180910390a35050565b5050565b6001600160a01b0380831660009081526004602090815260408083209385168352600584019091528120600101549091901580610ec5575060048101546001600160a01b038416600090815260058301602052604090206001015411155b15610ed8576002015460ff169050610ef1565b3360009081526005909101602052604090205460ff1690505b92915050565b610eff612946565b610f6a5760405162461bcd60e51b815260206004820152603660248201527f6e6f7420616c6c6f77656420746f206372656174652061207472616e73666572604482015275206f6620636f6e666973636174656420706c6564676560501b606482015260840161091c565b806009541015610faf5760405162461bcd60e51b815260206004820152601060248201526f6e6f7420656e6f7567682066756e647360801b604482015260640161091c565b600b80546000818152600c602052604081209290610fcc83612ede565b9091555081556001810180546001600160a01b0319166001600160a01b038516179055600281018290556009805483919060009061100b908490612f7f565b909155506000905081546040516000815260008051602061300e8339815191529060200160405180910390a3505050565b60405163badc206560e01b81523360048201523090819063badc2065906024016020604051808303816000875af115801561107b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061109f9190612f96565b6111115760405162461bcd60e51b815260206004820152603860248201527f7468652063616c6c6572206973206e6f7420617574686f72697a656420746f2060448201527f7365742074686520636172626f6e20666f6f747072696e740000000000000000606482015260840161091c565b6001600160a01b038316330361117a5760405162461bcd60e51b815260206004820152602860248201527f7468652061756469746f722063616e6e6f742073657420697473206f776e20666044820152671bdbdd1c1c9a5b9d60c21b606482015260840161091c565b6001600160a01b038316600090815260036020526040902054801580156111a15750600083115b156111c2576001600160a01b03841660009081526003602052604090208390555b6000811180156111d25750600083115b156111f3576001600160a01b03841660009081526003602052604090208390555b600081118015611201575082155b15611220576001600160a01b0384166000908152600360205260408120555b836001600160a01b03167f4a4e48dea93c3be0cee4d331f816573cf58d3dabc07503caa878df70b04d84548460405161125b91815260200190565b60405180910390a250505050565b6001600160a01b0381166112b55760405162461bcd60e51b81526020600482015260136024820152726e6f7420612076616c6964206164647265737360681b604482015260640161091c565b6001600160a01b038181166000908152600f602052604090205416156113435760405162461bcd60e51b815260206004820152603f60248201527f7468652064656c6567617465206164647265737320697320616c72656164792060448201527f6d617070656420746f20616e20616464726573732c20726576657274696e6700606482015260840161091c565b6001600160a01b0381166000818152600f602090815260409182902080546001600160a01b031916339081179091559151600181527ffb650c3ce2bf4f990ed30f2a9181ebfe0a084b623a2f9086bf09b59104a91beb91015b60405180910390a350565b6113af612946565b61141a5760405162461bcd60e51b815260206004820152603660248201527f6e6f7420616c6c6f77656420746f2063616e63656c2061207472616e73666572604482015275206f6620636f6e666973636174656420706c6564676560501b606482015260840161091c565b600b54811061143b5760405162461bcd60e51b815260040161091c90612e8a565b6000818152600c60205260409020600581015460ff161561149e5760405162461bcd60e51b815260206004820152601a60248201527f63616e6e6f742063616e63656c20746865207472616e73666572000000000000604482015260640161091c565b8060020154600960008282546114b49190612f26565b90915550506000600282015560058101805460ff1916600117905560048154600383015460405190815260008051602061300e83398151915290602001610e57565b600060026008540361154a5760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c00604482015260640161091c565b6002600855336000908152600a60205260409020548211156115a15760405162461bcd60e51b815260206004820152601060248201526f6e6f7420656e6f7567682066756e647360801b604482015260640161091c565b6001600160a01b0383166116035760405162461bcd60e51b815260206004820152602360248201527f63616e6e6f74207472616e7366657220746f20746865207a65726f206164647260448201526265737360e81b606482015260840161091c565b600061160f8484610c4b565b5090508061166a5760405162461bcd60e51b815260206004820152602260248201527f6e6f7420616c6c6f77656420746f207472616e7366657220706c65646765206f6044820152611d5d60f21b606482015260840161091c565b336000908152600a602052604081208054859290611689908490612f7f565b90915550506040516001600160a01b0385169084156108fc029085906000818181858888f193505050501580156116c4573d6000803e3d6000fd5b50336000818152600a602090815260408083205481519384529183018790528201527fb88fe15da9ba06a19253d931dd262ba84bd274d4e70abbece6f917d0d945cea79060600160405180910390a26001915050600160085592915050565b6001600160a01b03811661176f5760405162461bcd60e51b81526020600482015260136024820152726e6f7420612076616c6964206164647265737360681b604482015260640161091c565b6001600160a01b038181166000908152600f60205260409020541633146117fe5760405162461bcd60e51b815260206004820152603b60248201527f7468652064656c65676174652061646472657373206973206e6f74206d61707060448201527f656420746f207468652063616c6c65722c20726576657274696e670000000000606482015260840161091c565b6001600160a01b0381166000818152600f6020908152604080832080546001600160a01b03191690555191825233917ffb650c3ce2bf4f990ed30f2a9181ebfe0a084b623a2f9086bf09b59104a91beb910161139c565b600061185f612809565b509050600081600281111561187657611876612de2565b036118c35760405162461bcd60e51b815260206004820181905260248201527f6e6f7420616c6c6f77656420746f2063726561746520612070726f706f73616c604482015260640161091c565b600e80546000818152600d6020526040812092906118e083612ede565b909155508155436001820155600081546040517f8b4f54c8f369dfa88cad572b520d502c98a5b5fba0da475fff124aa383f883b790600090a35050565b336000908152600a60205260408120805434929061193c908490612f26565b9091555050336000818152600a60205260408082205490517fb88fe15da9ba06a19253d931dd262ba84bd274d4e70abbece6f917d0d945cea792611990923483526020830191909152604082015260600190565b60405180910390a2565b6001600160a01b03811660009081526002602052604081205460ff168015610ef15750506001600160a01b0316600090815260036020526040902054151590565b6001600160a01b0381166000908152600460205260408120600681015482611a227f2245a186a3377a3ebaff278b0642aeae1bfb62eb3f0c54958a9873924182c1b0612871565b90506000836007015443611a369190612f7f565b90506000611a637fae12cf5b0128e49037eacee7baa7c46c8833cea54780ebf80efbdd27e19c66ea612871565b90508282108015611a745750600084115b15611aa55782611a848386612fb3565b611a8e9190612fd2565b611a988583612f26565b611aa29190612f7f565b90505b9695505050505050565b600080805b600054811015611b01576000818152600160209081526040808320546001600160a01b031683526003909152902054611aed9083612f26565b915080611af981612ede565b915050611ab4565b50919050565b6001600160a01b0381166000908152600460205260408120600281015430919060ff1615611bd057611b38846119db565b604051633c2f4a9760e01b81526001600160a01b038681166004830152841690633c2f4a9790602401602060405180830381865afa158015611b7e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611ba29190612ff4565b1015611bb2575060009392505050565b611bbb846119db565b60068201554360079091015550600192915050565b5060009392505050565b600e548110611bfb5760405162461bcd60e51b815260040161091c90612e8a565b6000818152600d60205260409020611c12816127ae565b611c4f5760405162461bcd60e51b815260206004820152600e60248201526d1d9bdd19481a5cc818db1bdcd95960921b604482015260640161091c565b600080611c5a612809565b90925090506000826002811115611c7357611c73612de2565b03611cb65760405162461bcd60e51b81526020600482015260136024820152726e6f7420616c6c6f77656420746f20766f746560681b604482015260640161091c565b8260080154600003611cf657436008840155600283546040517f8b4f54c8f369dfa88cad572b520d502c98a5b5fba0da475fff124aa383f883b790600090a35b6001826002811115611d0a57611d0a612de2565b03611de2576001600160a01b0381166000908152600784016020526040812054900b8019611d39575050505050565b8060000b600103611d9857600484018054906000611d5683612ec7565b9091555050600584018054906000611d6d83612ede565b90915550506001600160a01b03821660009081526007850160205260409020805460ff191660ff1790555b8060000b600003611de057600584018054906000611db583612ede565b90915550506001600160a01b03821660009081526007850160205260409020805460ff191660ff1790555b505b6002826002811115611df657611df6612de2565b03611ece576001600160a01b0381166000908152600684016020526040812054900b8019611e25575050505050565b8060000b600103611e8457600284018054906000611e4283612ec7565b9091555050600384018054906000611e5983612ede565b90915550506001600160a01b03821660009081526006850160205260409020805460ff191660ff1790555b8060000b600003611ecc57600384018054906000611ea183612ede565b90915550506001600160a01b03821660009081526006850160205260409020805460ff191660ff1790555b505b806001600160a01b0316847f62b7bd68cddcb1b426af8b4081bdc15715aea8fdd2b2d2d089eed9fd7949f4fb84600019604051610c3d929190612f0b565b336000908152600460205260409020805460ff16611fc157805460ff1916600117815543600382015560405133907fea5f6444a82c5a256b72b475714978ac87af927f8f6881498833df35cdc675d790600090a2600754600003611f7857611f7333612956565b611f8c565b60028101805460ff19169055600060018201555b60068054600090815260056020526040812080546001600160a01b0319163317905581549190611fbb83612ede565b91905055505b50565b6000806000806000600b548610611fed5760405162461bcd60e51b815260040161091c90612e8a565b50505060009283525050600c602052604090208054600282015460018301546003840154600590940154929491936001600160a01b0390911692909160ff90911690565b612039612946565b6120a55760405162461bcd60e51b815260206004820152603760248201527f6e6f7420616c6c6f77656420746f20617070726f76652061207472616e73666560448201527672206f6620636f6e666973636174656420706c6564676560481b606482015260840161091c565b600b5481106120c65760405162461bcd60e51b815260040161091c90612e8a565b6000818152600c60205260409020600581015460ff16156120f95760405162461bcd60e51b815260040161091c90612f3e565b33600090815260048201602052604090205460ff1615612117575050565b60038101805490600061212983612ede565b90915550503360009081526004820160205260409020805460ff19166001908117909155610e36565b60008080808080808080806121867f86decdbf2b88f40922ce6fa2dd8dd30139a7d1450b7f7624aabaf7e091b6c300612871565b905060006121b37f1ee4b196734418ec34eadb6d3d8a5be7cc50000fb7fd8e10cc1ef2b650933ee5612871565b9050600e548c106121d65760405162461bcd60e51b815260040161091c90612e8a565b60008c8152600d6020526040902080546001820154909c5099506121fa838b612f26565b8160080154106122105780600801549850612223565b8281600101546122209190612f26565b98505b61222d828a612f26565b975080600401549650806005015495508060020154945080600301549350612254816129f1565b9a505050509193959799909294969850565b6000806122728361199a565b905080156122835750600192915050565b6001600160a01b038381166000908152600f6020526040902054168015611bd0576122ad8161199a565b949350505050565b6001600160a01b038216600090815260046020526040902030906122d7612946565b6123495760405162461bcd60e51b815260206004820152603d60248201527f6f6e6c792061756469746564206e6f646573207768696368206861766520666f60448201527f6f747072696e742063616e20766f746520666f722061756469746f7273000000606482015260840161091c565b805460ff166123aa5760405162461bcd60e51b815260206004820152602760248201527f7468652070726f706f736564205f61756469746f72206973206e6f74207265676044820152661a5cdd195c995960ca1b606482015260840161091c565b60006123b68533610e67565b905060006002846001600160a01b03166303b2ec986040518163ffffffff1660e01b8152600401602060405180830381865afa1580156123fa573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061241e9190612ff4565b6124289190612fd2565b612433906001612f26565b90508115158515151461256957336000818152600585016020908152604091829020436001820155805460ff191689151590811790915591519182526001600160a01b038916917f8f1e528bc557e46d5f284afa1920cf3efd575fe1e291fe9007ec10755ae84db0910160405180910390a3600283015460ff1661251b5784156124d3576001830180549060006124c983612ede565b91905055506124eb565b6001830180549060006124e583612ec7565b91905055505b6001600160a01b03861660009081526004602052604090206001015481116125165761251686612956565b612569565b841561253d5760018301805490600061253383612ec7565b9190505550612555565b60018301805490600061254f83612ede565b91905055505b808360010154106125695761256986612b1d565b505050505050565b336000818152600a602052604090205490610e6390826114f6565b6002600854036125de5760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c00604482015260640161091c565b60026008556125eb612946565b6126575760405162461bcd60e51b815260206004820152603760248201527f6e6f7420616c6c6f77656420746f20657865637574652061207472616e73666560448201527672206f6620636f6e666973636174656420706c6564676560481b606482015260840161091c565b600b5481106126785760405162461bcd60e51b815260040161091c90612e8a565b6000818152600c60205260409020600581015460ff16156126db5760405162461bcd60e51b815260206004820152601b60248201527f63616e6e6f74206578656375746520746865207472616e736665720000000000604482015260640161091c565b6126e88160030154612bc2565b61272b5760405162461bcd60e51b81526020600482015260146024820152736e6f7420656e6f75676820617070726f76616c7360601b604482015260640161091c565b600181015460028201546040516001600160a01b039092169181156108fc0291906000818181858888f1935050505015801561276b573d6000803e3d6000fd5b5060058101805460ff1916600117905560038154600383015460405190815260008051602061300e8339815191529060200160405180910390a350506001600855565b6000806127ba836129f1565b905060018160048111156127d0576127d0612de2565b036127de5750600192915050565b60028160048111156127f2576127f2612de2565b036128005750600192915050565b50600092915050565b33600090815260046020526040812060020154819060ff161561282f5750600191339150565b61283833612266565b1561286857336000908152600f60205260409020546001600160a01b03168061285e5750335b6002939092509050565b50600091339150565b60007f79213240d4770bf6dd31905d22722cfec6582ebaf48089db5545081f6e493d0082016128a45750621e1338919050565b7fe11b4e698cbbe713cb152492c275a41833affff0480271ef33e10d49af6cc11b82016128d55750620a0668919050565b7fddba5e795cc885c14500d874f9bd5151e4049d14c0f3ab6a75678c6dbe7d3e5082016129065750621e1338919050565b7f51ed30a4fed71b6fc815311845583b9377cc315ab87f1407f10422d81e639916820161293e575069010f0cf064dd59200000919050565b506000919050565b600061295133612266565b905090565b6001600160a01b0381166000908152600460205260409020600281015460ff16610e635760028101805460ff19166001908117909155600090820181905543600483015560078054916129a883612ede565b9091555050604051600181526001600160a01b038316907f705439d120e886dc803c3ef246dabd908c8d139e0972cfabd6ed2815fd6ff497906020015b60405180910390a25050565b600080612a1d7f86decdbf2b88f40922ce6fa2dd8dd30139a7d1450b7f7624aabaf7e091b6c300612871565b90506000612a4a7f1ee4b196734418ec34eadb6d3d8a5be7cc50000fb7fd8e10cc1ef2b650933ee5612871565b6008850154600186015491925090811015612a7257828560010154612a6f9190612f26565b90505b6000612a7e8383612f26565b905081431015612a915760009450612b14565b804311612ae3578560030154866002015487600501548860040154612ab69190612f26565b612ac09190612f26565b612aca9190612f26565b600003612ada5760019450612b14565b60029450612b14565b85600301548660020154118015612b01575085600501548660040154115b15612b0f5760039450612b14565b600494505b50505050919050565b6001600160a01b0381166000908152600460205260409020600281015460ff1615610e635760028101805460ff19169055600060018201819055600780830182905560068301829055436004840155805491612b7883612ec7565b9190505550612b8682612c49565b604051600081526001600160a01b038316907f705439d120e886dc803c3ef246dabd908c8d139e0972cfabd6ed2815fd6ff497906020016129e5565b600080306001600160a01b03166303b2ec986040518163ffffffff1660e01b8152600401602060405180830381865afa158015612c03573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612c279190612ff4565b9050612c34600282612fd2565b612c3f906001612f26565b9092101592915050565b611fc1816001600160a01b0381166000908152600a602052604081205490819003612c72575050565b8060096000828254612c849190612f26565b90915550506001600160a01b0382166000818152600a6020908152604080832083905580518381529182018590528101919091527fb88fe15da9ba06a19253d931dd262ba84bd274d4e70abbece6f917d0d945cea79060600160405180910390a2816001600160a01b03167f390e2dc8b7e124b66909dd0e8992eb6675c850d1ad208db223dc691057553ed4826009546040516129e5929190918252602082015260400190565b6001600160a01b0381168114611fc157600080fd5b600060208284031215612d5257600080fd5b8135612d5d81612d2b565b9392505050565b600060208284031215612d7657600080fd5b5035919050565b60008060408385031215612d9057600080fd5b8235612d9b81612d2b565b946020939093013593505050565b60008060408385031215612dbc57600080fd5b8235612dc781612d2b565b91506020830135612dd781612d2b565b809150509250929050565b634e487b7160e01b600052602160045260246000fd5b898152610120810160058a10612e1057612e10612de2565b602082019990995260408101979097526060870195909552608086019390935260a085019190915260c084015260e083015261010090910152919050565b8015158114611fc157600080fd5b60008060408385031215612e6f57600080fd5b8235612e7a81612d2b565b91506020830135612dd781612e4e565b6020808252600d908201526c0d2dcecc2d8d2c840d2dcc8caf609b1b604082015260600190565b634e487b7160e01b600052601160045260246000fd5b600081612ed657612ed6612eb1565b506000190190565b600060018201612ef057612ef0612eb1565b5060010190565b60038110612f0757612f07612de2565b9052565b60408101612f198285612ef7565b8260208301529392505050565b60008219821115612f3957612f39612eb1565b500190565b60208082526021908201527f746865207472616e7366657220697320616c726561647920636f6d706c6574656040820152601960fa1b606082015260800190565b600082821015612f9157612f91612eb1565b500390565b600060208284031215612fa857600080fd5b8151612d5d81612e4e565b6000816000190483118215151615612fcd57612fcd612eb1565b500290565b600082612fef57634e487b7160e01b600052601260045260246000fd5b500490565b60006020828403121561300657600080fd5b505191905056fe90e0773edceb1519f6d8994ff046d89bccdfd3a143ad7b79567af23ae0150993a2646970667358221220866f455fc24c0a122f6185f999f86d2999a88d0e042c5880664eaef15e90417864736f6c634300080e0033"),
			},
			pocr2Addr: {
				Balance: big.NewInt(0),
				Code:    common.Hex2Bytes("608060"),
			},
		},
		BaseFee: big.NewInt(params.InitialBaseFee),
	}
	copy(genspec.ExtraData[extraVanity:], addr[:])
	genesis := genspec.MustCommit(db)

	// Generate a batch of blocks, each properly signed
	chain, _ := core.NewBlockChain(db, nil, params.AllCliqueProtocolChanges, engine, vm.Config{}, nil, nil)
	defer chain.Stop()

	blocks, _ := core.GenerateChain(params.AllCliqueProtocolChanges, genesis, engine, db, 3, func(i int, block *core.BlockGen) {
		// The chain maker doesn't have access to a chain, so the difficulty will be
		// lets unset (nil). Set it here to the correct value.
		block.SetDifficulty(diffInTurn)

		// We want to simulate an empty middle block, having the same state as the
		// first one. The last is needs a state change again to force a reorg.
		if i != 1 {
			tx, err := types.SignTx(types.NewTransaction(block.TxNonce(addr), common.Address{0x00}, new(big.Int), params.TxGas, block.BaseFee(), nil), signer, key)
			if err != nil {
				panic(err)
			}
			block.AddTxWithChain(chain, tx)
		}
	})
	for i, block := range blocks {
		header := block.Header()
		if i > 0 {
			header.ParentHash = blocks[i-1].Hash()
		}
		header.Extra = make([]byte, extraVanity+extraSeal)
		header.Difficulty = diffInTurn

		sig, _ := crypto.Sign(engine.SealHash(header).Bytes(), key)
		copy(header.Extra[len(header.Extra)-extraSeal:], sig)
		blocks[i] = block.WithSeal(header)
	}
	// Insert the first two blocks and make sure the chain is valid
	db = rawdb.NewMemoryDatabase()
	genspec.MustCommit(db)

	chain, _ = core.NewBlockChain(db, nil, params.AllCliqueProtocolChanges, engine, vm.Config{}, nil, nil)
	defer chain.Stop()

	if _, err := chain.InsertChain(blocks[:2]); err != nil {
		t.Fatalf("failed to insert initial blocks: %v", err)
	}
	if head := chain.CurrentBlock().NumberU64(); head != 2 {
		t.Fatalf("chain head mismatch: have %d, want %d", head, 2)
	}

	// Simulate a crash by creating a new chain on top of the database, without
	// flushing the dirty states out. Insert the last block, triggering a sidechain
	// reimport.
	chain, _ = core.NewBlockChain(db, nil, params.AllCliqueProtocolChanges, engine, vm.Config{}, nil, nil)
	defer chain.Stop()

	if _, err := chain.InsertChain(blocks[2:]); err != nil {
		t.Fatalf("failed to insert final block: %v", err)
	}
	if head := chain.CurrentBlock().NumberU64(); head != 3 {
		t.Fatalf("chain head mismatch: have %d, want %d", head, 3)
	}
}
